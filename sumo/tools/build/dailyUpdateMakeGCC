#!/bin/bash
if test "x$1" = "x"; then
  PREFIX=$HOME
else
  PREFIX=$1
fi
if test "x$2" = "x"; then
  FILEPREFIX=gcc4
else
  FILEPREFIX=$2
fi
if test "x$3" = "x"; then
  REMOTEDIR="shell.sf.net:sumo-www/daily/"
else
  REMOTEDIR=$3
fi
if test "x$4" != "x"; then
  SMTP_SERVER=$4
fi
MAKELOG=$PREFIX/${FILEPREFIX}make.log
RUNLOG=$PREFIX/${FILEPREFIX}examplelogs.tar.gz
MAKEALLLOG=$PREFIX/${FILEPREFIX}makealloptions.log
STATUSLOG=$PREFIX/${FILEPREFIX}status.log
BATCH_RESULT_DIR=$PREFIX/${FILEPREFIX}batch_result
REPORT_DIR=$PREFIX/${FILEPREFIX}report

rm -f $STATUSLOG
echo -n "$FILEPREFIX, " > $STATUSLOG
date >> $STATUSLOG
echo "--" >> $STATUSLOG
cd $PREFIX/sumo
make distclean &> /dev/null
make -f Makefile.cvs clean &> /dev/null
echo `basename $MAKELOG`.gz >> $STATUSLOG
svn up &> $MAKELOG || (echo "svn up failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
if test `wc -l < $MAKELOG` -le 13; then
#  echo "no changes since last run, skipping build and test"
  exit
fi
make -f Makefile.cvs >> $MAKELOG 2>&1 || (echo "autoreconf failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
./configure --prefix=$PREFIX >> $MAKELOG 2>&1 || (echo "configure failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
make dist >> $MAKELOG 2>&1 || (echo "make dist failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
make doc >> $MAKELOG 2>&1 || (echo "make doc failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
make >> $MAKELOG 2>&1 || (echo "make failed" | tee -a $STATUSLOG; tail -20 $MAKELOG)
make install >> $MAKELOG 2>&1 || (echo "make install failed" | tee -a $STATUSLOG; tail -10 $MAKELOG)
echo `grep -c warning $MAKELOG` warnings >> $STATUSLOG
gzip -f $MAKELOG
scp -q $MAKELOG.gz $REMOTEDIR

echo "--" >> $STATUSLOG
if test -e $PREFIX/bin/sumo -a $PREFIX/bin/sumo -nt $PREFIX/sumo/configure; then
  # run tests
  export PATH=$PREFIX/texttest/bin:$PATH
  export TEXTTEST_TMP=$PREFIX/texttesttmp
  find $BATCH_RESULT_DIR -mtime +20 -type f | xargs -r rm
  rm -rf $REPORT_DIR/* $TEXTTEST_TMP/*
  tests/testDaily.sh $PREFIX/bin $BATCH_RESULT_DIR $REPORT_DIR $SMTP_SERVER &> $TEXTTEST_TMP/${FILEPREFIX}test.log
  find $TEXTTEST_TMP -name batchreport."*" -exec echo -n '{} ' \; -exec head -1 '{}' \; | sort >> $STATUSLOG
  scp -qr $REPORT_DIR $REMOTEDIR

  # run examples
  find data/examples -name "*.sumo.cfg" -exec src/sumo -c '{}' -l '{}'.log \; &> /dev/null
  find data/examples/ -newer $MAKELOG.gz -type f > /tmp/sumo_examples 2> /dev/null
  tar -czf $RUNLOG -T /tmp/sumo_examples --remove-files &> /dev/null
  scp -q $RUNLOG $REMOTEDIR
fi

echo "--" >> $STATUSLOG
echo `basename $MAKEALLLOG`.gz >> $STATUSLOG
export CXXFLAGS="-Wall -W -Wfloat-equal -pedantic -Wno-long-long"
./configure --with-fox-libraries=$PREFIX/lib --with-fox-includes=$PREFIX/include/fox-1.4 \
--with-proj-gdal=$PREFIX --enable-double-precision --enable-traci \
--enable-debug --enable-speedcheck --enable-memcheck &> $MAKEALLLOG || (echo "configure with all options failed" | tee -a $STATUSLOG; tail -10 $MAKEALLLOG)
make clean all >> $MAKEALLLOG 2>&1 || (echo "make with all options failed" | tee -a $STATUSLOG; tail -20 $MAKEALLLOG)
echo `grep -c warning $MAKEALLLOG` warnings >> $STATUSLOG
gzip -f $MAKEALLLOG
scp -q $MAKEALLLOG.gz $REMOTEDIR
echo "--" >> $STATUSLOG
scp -q $STATUSLOG $REMOTEDIR
